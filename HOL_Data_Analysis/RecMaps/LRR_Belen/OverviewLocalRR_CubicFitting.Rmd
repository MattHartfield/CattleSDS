---
title: "Overview Local recombination rate"
author: "T.B"
date: "10/3/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Importing the data 



```{r getData}
# DATA
chrD=read.table(file ="filtered_recombination_data_withBin")

names(chrD)=c("R_ID", "Chrm","PhysD","Pos3.0+1","Index",
              "BTAU","BTAU+1","cM","ID1","Database",
              "ID2","Type","Informative_Meiosis",
              "Kosambi_distance","BinID")

head(chrD)
##############

```

## Looking at the trend on chromsome 1
We are just examining closer the chromosome 1 as an example but this trend is quite repeatable among all chromosomes

```{r chr1, echo=FALSE}
chrm=1 #choosing here one particular chromsome
Toscale=10^6 # I want to have Mb as physical distance units
chrD_selectionChrm = chrD[chrD[,2]==chrm,]
chrD_selectionChrm$PhysD=chrD_selectionChrm$PhysD/Toscale
plot(chrD_selectionChrm$PhysD,chrD_selectionChrm$cM, pch=20, cex=0.25, col="grey30",
       xlab="Cumulated Physical distance (Mb)", ylab="CUMULATED cM", main=paste("Empirical trend on chr ", chrm))

```

## The cubic fit of genetic distances along the chromosome
We use a cubic fit using least squares for fitting (standard polynomial regression). Note that we use the following convention when regression genetic distance (in cM) against physical distance D (in Mb) $$ cM = a + b D + C D^2 + d D^3 $$.  

```{r cubic_regression}
CubReg=lm(cM~PhysD + I(PhysD^2) + I(PhysD^3), 
            data=chrD_selectionChrm)
summary(CubReg)
  # Terms of the of the cubic equation:
  CubReg$coefficients
  a = CubReg$coefficients[1]
  b = CubReg$coefficients[2]
  c = CubReg$coefficients[3]
  d = CubReg$coefficients[4]

```
## Checking visually the polynomial fit

```{r visual check}
plot(chrD_selectionChrm$PhysD,chrD_selectionChrm$cM, pch=20, cex=0.25, col="grey30",
       xlab="Cumulated Physical distance (Mb)", ylab="CUMULATED cM", main=paste("Obs versus fitted trend on chr ", chrm))
lines(chrD_selectionChrm$PhysD,CubReg$fitted.values, type = "l", col="cornflowerblue", lwd=2)

```

## Fitting the whole set of chromosomes
```{r Loop over chr}
listChr=unique(chrD$Chrm)
Toscale=10^6 # I want to have Mb as physical distance units
for (chrm in 1:29){
  chrD_selectionChrm = chrD[chrD[,2]==chrm,]
  chrD_selectionChrm$PhysD=chrD_selectionChrm$PhysD/Toscale
  CubReg=lm(cM~PhysD + I(PhysD^2) + I(PhysD^3), 
            data=chrD_selectionChrm)
  plot(chrD_selectionChrm$PhysD,chrD_selectionChrm$cM, pch=20, cex=0.25,
       col="grey30", 
       xlab="Cumulated Physical distance (Mb)", ylab="CUMULATED cM",
       main=paste("Obs versus fitted trend on chr ", chrm))
  lines(chrD_selectionChrm$PhysD,CubReg$fitted.values, type = "l",
        col="cornflowerblue", lwd=2)
}
```

## Overview of the variation in local recombination rates throughout the genome

```{r overview cM/Mb}
## Examine and parse the estimated local recombination rates from Belen's script.

library(tidyverse) 
df=read_csv("local_recomb_rate_per_bin_NEW.txt",col_names = c("chr","bin","begin","end","mid", "cMperMb"),progress = T)
names(df)
glimpse(df)
head(df)
dim(df)
summary(df)

df %>%  filter(!is.na(cMperMb)) -> df # excluding bins with no LRR

dim(df)
ggplot(data = df) + geom_histogram(aes(x=cMperMb),binwidth = 0.1)

# per chromosome
df %>% group_by(chr) %>% 
  summarise(mean=mean(cMperMb),
            median=median(cMperMb),
            Nbins=n()) ->cMperMBChrom

cMperMBChrom

ggplot(data = df) + 
  geom_histogram(aes(x=cMperMb, fill=chr)) + 
  facet_wrap(~chr) +
  NULL

```

